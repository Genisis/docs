<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head xmlns="http://www.w3.org/1999/xhtml"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Top Children Query</title><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Reference" /><link rel="up" href="query-dsl-queries.html" title="Queries" /><link rel="prev" href="query-dsl-terms-query.html" title="Terms Query" /><link rel="next" href="query-dsl-wildcard-query.html" title="Wildcard Query" /><script xmlns="" type="text/javascript" src="http://www.elasticsearch.org/wp-includes/js/jquery/jquery.js?ver=1.8.3"></script><link xmlns="" rel="stylesheet" id="prettify-gc-syntax-highlighter-css" href="http://www.elasticsearch.org/content/plugins/prettify-gc-syntax-highlighter/prettify.css?ver=3.5.2" type="text/css" media="all" /><link xmlns="" rel="stylesheet" id="appStyles-css" href="http://www.elasticsearch.org/content/themes/elasticsearch-org/css/main.css?ver=1376314515" type="text/css" media="all" /><script xmlns="" type="text/javascript" src="http://www.elasticsearch.org/content/themes/elasticsearch-org/js/vendor/modernizr-2.6.1.min.js?ver=1"></script><script xmlns="" type="text/javascript" src="http://www.elasticsearch.org/content/themes/elasticsearch-org/js/vendor/selectivizr-min.js?ver=1"></script><script xmlns="" type="text/javascript" src="http://www.elasticsearch.org/content/themes/elasticsearch-org/js/plugins.min.js?ver=1375472072"></script><link xmlns="" rel="stylesheet" type="text/css" href="styles.css" /></head><body class="single single-guide"><div class="global_wrapper"><div id="index" class="page_content"><div class="container"><section class="full_width guide"><article class="guide_content"><div class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">Reference</a></span> &gt; <span class="breadcrumb-link"><a href="query-dsl.html">Query DSL</a></span> &gt; <span class="breadcrumb-link"><a href="query-dsl-queries.html">Queries</a></span> &gt; <span class="breadcrumb-node">Top Children Query</span></div><div class="navheader"><span class="prev"><a href="query-dsl-terms-query.html">
              « 
              Terms Query</a>
           
        </span><span class="next">
           
          <a href="query-dsl-wildcard-query.html">Wildcard Query
               » 
            </a></span></div><div xmlns="http://www.w3.org/1999/xhtml" class="section"><div class="titlepage"><div><div><h2 class="title"><a id="query-dsl-top-children-query"></a>Top Children Query</h2></div></div></div><div xmlns="" class="toc"><dl><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-match-query.html">Match Query</a></span></dt><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-multi-match-query.html">Multi Match Query</a></span></dt><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-bool-query.html">Bool Query</a></span></dt><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-boosting-query.html">Boosting Query</a></span></dt><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-common-terms-query.html">Common Terms Query</a></span></dt><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-custom-filters-score-query.html">Custom Filters Score Query</a></span></dt><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-ids-query.html">Ids Query</a></span></dt><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-custom-score-query.html">Custom Score Query</a></span></dt><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-custom-boost-factor-query.html">Custom Boost Factor Query</a></span></dt><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-constant-score-query.html">Constant Score Query</a></span></dt><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-dis-max-query.html">Dis Max Query</a></span></dt><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-field-query.html">Field Query</a></span></dt><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-filtered-query.html">Filtered Query</a></span></dt><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-flt-query.html">Fuzzy Like This Query</a></span></dt><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-flt-field-query.html">Fuzzy Like This Field Query</a></span></dt><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-fuzzy-query.html">Fuzzy Query</a></span></dt><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-geo-shape-query.html">GeoShape Query</a></span></dt><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-has-child-query.html">Has Child Query</a></span></dt><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-has-parent-query.html">Has Parent Query</a></span></dt><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-indices-query.html">Indices Query</a></span></dt><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-match-all-query.html">Match All Query</a></span></dt><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-mlt-query.html">More Like This Query</a></span></dt><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-mlt-field-query.html">More Like This Field Query</a></span></dt><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-nested-query.html">Nested Query</a></span></dt><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-prefix-query.html">Prefix Query</a></span></dt><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-query-string-query.html">Query String Query</a></span></dt><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-range-query.html">Range Query</a></span></dt><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-regexp-query.html">Regexp Query</a></span></dt><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-span-first-query.html">Span First Query</a></span></dt><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-span-multi-term-query.html">Span Multi Term Query</a></span></dt><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-span-near-query.html">Span Near Query</a></span></dt><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-span-not-query.html">Span Not Query</a></span></dt><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-span-or-query.html">Span Or Query</a></span></dt><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-span-term-query.html">Span Term Query</a></span></dt><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-term-query.html">Term Query</a></span></dt><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-terms-query.html">Terms Query</a></span></dt><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-top-children-query.html">Top Children Query</a></span></dt><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-wildcard-query.html">Wildcard Query</a></span></dt><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-text-query.html">Text Query</a></span></dt><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-minimum-should-match.html">Minimum Should Match</a></span></dt><dt xmlns="http://www.w3.org/1999/xhtml"><span class="section"><a href="query-dsl-multi-term-rewrite.html">Multi Term Query Rewrite</a></span></dt></dl></div><p>The <code class="literal">top_children</code> query runs the child query with an estimated hits
size, and out of the hit docs, aggregates it into parent docs. If there
aren’t enough parent docs matching the requested from/size search
request, then it is run again with a wider (more hits) search.</p><p>The <code class="literal">top_children</code> also provide scoring capabilities, with the ability
to specify <code class="literal">max</code>, <code class="literal">sum</code> or <code class="literal">avg</code> as the score type.</p><p>One downside of using the <code class="literal">top_children</code> is that if there are more child
docs matching the required hits when executing the child query, then the
<code class="literal">total_hits</code> result of the search response will be incorrect.</p><p>How many hits are asked for in the first child query run is controlled
using the <code class="literal">factor</code> parameter (defaults to <code class="literal">5</code>). For example, when asking
for 10 parent docs (with <code class="literal">from</code> set to 0), then the child query will
execute with 50 hits expected. If not enough parents are found (in our
example 10), and there are still more child docs to query, then the
child search hits are expanded by multiplying by the
<code class="literal">incremental_factor</code> (defaults to <code class="literal">2</code>).</p><p>The required parameters are the <code class="literal">query</code> and <code class="literal">type</code> (the child type to
execute the query on). Here is an example with all different parameters,
including the default values:</p><pre class="programlisting prettyprint noescape lang-js">{
    "top_children" : {
        "type": "blog_tag",
        "query" : {
            "term" : {
                "tag" : "something"
            }
        },
        "score" : "max",
        "factor" : 5,
        "incremental_factor" : 2
    }
}</pre><h4><a id="_scope_4"></a>Scope</h4><p>A <code class="literal">_scope</code> can be defined on the query allowing to run facets on the
same scope name that will work against the child documents. For example:</p><pre class="programlisting prettyprint noescape lang-js">{
    "top_children" : {
        "_scope" : "my_scope",
        "type": "blog_tag",
        "query" : {
            "term" : {
                "tag" : "something"
            }
        }
    }
}</pre><h4><a id="_memory_considerations_7"></a>Memory Considerations</h4><p>With the current implementation, all <code class="literal">_id</code> values are loaded to memory
(heap) in order to support fast lookups, so make sure there is enough
memory for it.</p></div><div class="navfooter"><span class="prev"><a href="query-dsl-terms-query.html">
              « 
              Terms Query</a>
           
        </span><span class="next">
           
          <a href="query-dsl-wildcard-query.html">Wildcard Query
               » 
            </a></span></div></article></section></div></div></div><script type="text/javascript" src="http://www.elasticsearch.org/content/plugins/prettify-gc-syntax-highlighter/prettify.js?ver=3.5.2"></script><script type="text/javascript" src="http://www.elasticsearch.org/content/plugins/prettify-gc-syntax-highlighter/launch.js?ver=3.5.2"></script></body></html>
