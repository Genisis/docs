<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Terms Aggregation</title><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Reference [1.x]" /><link rel="up" href="search-aggregations.html" title="Aggregations" /><link rel="prev" href="search-aggregations-bucket-reverse-nested-aggregation.html" title="Reverse nested Aggregation" /><link rel="next" href="search-aggregations-bucket-significantterms-aggregation.html" title="Significant Terms Aggregation" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta content="width=device-width, initial-scale=1.0" name="viewport" /><link rel="shortcut icon" href="http://www.elasticsearch.org/content/themes/elasticsearch-org/favicon.ico" /><link rel="stylesheet" id="prettify-gc-syntax-highlighter-css" href="http://www.elasticsearch.org/content/plugins/prettify-gc-syntax-highlighter/prettify.css?ver=3.5.2" type="text/css" media="all" /><link rel="stylesheet" id="appStyles-css" href="http://www.elasticsearch.org/content/themes/elasticsearch-org/css/main.css?ver=1395693666" type="text/css" media="all" /><script type="text/javascript" src="http://www.elasticsearch.org/wp-includes/js/jquery/jquery.js?ver=1.8.3"></script><link rel="stylesheet" href="http://www.elasticsearch.org/content/themes/elasticsearch-org/style.css" type="text/css" media="all" /><script src="//cdn.optimizely.com/js/281975433.js"></script><script src="//fast.wistia.com/static/iframe-api-v1.js"></script><script type="text/javascript">
      jQuery(function() {
        jQuery('div.navheader+div').css('minHeight',jQuery('div.toc').height()+'px');
        jQuery('article.guide_content a[id]').each(function() { this.href='#'+this.id });
      });
    </script><link rel="stylesheet" type="text/css" href="styles.css?3" /></head><body class="single single-guide"><img src="http://ad.retargeter.com/seg?add=1235131&amp;t=2" width="1" height="1" style="position:absolute; visibility:hidden;" /><script type="text/javascript">
        if(jQuery('body').data('cookie') != "eu" || jQuery.cookie('allowCookies')){
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-12395217-2']);
        _gaq.push(['_trackPageview']);
        (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    }</script><!--[if lt IE 8]>
        <p class="chromeframe">You are using an outdated browser. <a href="http://browsehappy.com/">Upgrade your browser today</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to better experience this site.</p>
      <![endif]--><header><nav role="navigation" id="mobile-nav-container" class="off-canvas-nav"><ul id="mobile-nav" class="menu"><li id="menu-item-75892" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-75892"><a href="/overview/">Overview</a><ul class="sub-menu"><li id="menu-item-75895" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-75895"><a href="/overview/">Overview</a></li><li id="menu-item-68760" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-68760"><a href="/overview/elasticsearch/">Elasticsearch</a></li><li id="menu-item-75894" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-75894"><a href="/overview/marvel/">Marvel</a></li><li id="menu-item-68758" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-68758"><a href="/overview/kibana/">Kibana</a></li><li id="menu-item-68756" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-68756"><a href="/overview/kibana/installation/">Kibana Installation</a></li><li id="menu-item-68757" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-68757"><a href="/overview/kibana/support/">Kibana Support</a></li><li id="menu-item-68759" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-68759"><a href="/overview/logstash/">Logstash</a></li><li id="menu-item-74019" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-74019"><a href="/overview/hadoop/">Hadoop</a></li><li id="menu-item-75893" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-75893"><a href="/overview/elkdownloads/">ELK Downloads</a></li></ul></li><li id="menu-item-55" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-55"><a href="/resources/">Resources</a><ul class="sub-menu"><li id="menu-item-76342" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-76342"><a href="/guide/">Guide</a></li><li id="menu-item-4843" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-4843"><a href="/videos/">Videos</a></li></ul></li><li id="menu-item-657" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-657"><a href="/community/">Community</a></li><li id="menu-item-68802" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-68802"><a href="/case-studies/">Case Studies</a></li><li id="menu-item-45" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-45"><a href="/blog/">Blog</a></li><li id="menu-item-12" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12"><a target="_blank" href="http://elasticsearch.com">Company</a></li></ul><ul class="add-on"><li><a href="/overview/elkdownloads/">Download</a></li></ul></nav><div class="container"><div id="header-inner"><h1 id="header-logo"><a class="faux" href="http://www.elasticsearch.org">Elasticsearch</a></h1><nav role="navigation" id="main-nav-container" class="main-nav"><ul id="top-nav" class="menu"><li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-75892"><a href="/overview/">Overview</a></li><li class="menu-item menu-item-type-post_type menu-item-object-page current-menu-item page_item page-item-53 current_page_item menu-item-55"><a href="/resources/">Resources</a></li><li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-657"><a href="/community/">Community</a></li><li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-68802"><a href="/case-studies/">Case Studies</a></li><li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-45"><a href="/blog/">Blog</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12"><a target="_blank" href="http://elasticsearch.com">Company</a></li></ul><ul class="add-on"><li><a class="btn btn-primary" href="/overview/elkdownloads/">Download</a></li></ul></nav><div class="slide-trigger navigation" id="nav-trigger" aria-hidden="true"><span class="bar"></span><span class="bar"></span><span class="bar"></span></div><hr /><ul id="sub_nav"><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-76342"><a href="/guide/">Guide</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-4843"><a href="/videos/">Videos</a></li></ul></div></div></header><div class="global_wrapper"><div class="page_content"><div class="container"><section id="search_container" class="active"><form id="blog_search" role="search" action="/" method="get"><div class="blog_search_wrapper"><input id="s" name="s" class="search_term" type="text" placeholder="search" autocomplete="off" tabindex="1" /><input type="submit" class="search_submit" value=" " /><ul id="results"></ul></div></form></section><section class="full_width guide"><article class="guide_content"><div class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">Reference
      [1.x]
    </a></span> » <span class="breadcrumb-link"><a href="search.html">Search APIs </a></span> » <span class="breadcrumb-link"><a href="search-aggregations.html">Aggregations</a></span> » <span class="breadcrumb-node">Terms Aggregation</span></div><div class="navheader"><span class="prev"><a href="search-aggregations-bucket-reverse-nested-aggregation.html">
              « 
              Reverse nested Aggregation</a>
           
        </span><span class="next">
           
          <a href="search-aggregations-bucket-significantterms-aggregation.html">Significant Terms Aggregation
               »
            </a></span></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="search-aggregations-bucket-terms-aggregation"></a>Terms Aggregation<a href="https://github.com/elasticsearch/elasticsearch/edit/1.x/docs/reference/search/aggregations/bucket/terms-aggregation.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="search-aggregations-metrics-min-aggregation.html">Min Aggregation</a></span></dt><dt><span class="section"><a href="search-aggregations-metrics-max-aggregation.html">Max Aggregation</a></span></dt><dt><span class="section"><a href="search-aggregations-metrics-sum-aggregation.html">Sum Aggregation</a></span></dt><dt><span class="section"><a href="search-aggregations-metrics-avg-aggregation.html">Avg Aggregation</a></span></dt><dt><span class="section"><a href="search-aggregations-metrics-stats-aggregation.html">Stats Aggregation</a></span></dt><dt><span class="section"><a href="search-aggregations-metrics-extendedstats-aggregation.html">Extended Stats Aggregation</a></span></dt><dt><span class="section"><a href="search-aggregations-metrics-valuecount-aggregation.html">Value Count Aggregation</a></span></dt><dt><span class="section"><a href="search-aggregations-metrics-percentile-aggregation.html">Percentiles Aggregation</a></span></dt><dt><span class="section"><a href="search-aggregations-metrics-percentile-rank-aggregation.html">Percentile Ranks Aggregation</a></span></dt><dt><span class="section"><a href="search-aggregations-metrics-cardinality-aggregation.html">Cardinality Aggregation</a></span></dt><dt><span class="section"><a href="search-aggregations-metrics-geobounds-aggregation.html">Geo Bounds Aggregation</a></span></dt><dt><span class="section"><a href="search-aggregations-metrics-top-hits-aggregation.html">Top hits Aggregation</a></span></dt><dt><span class="section"><a href="search-aggregations-bucket-global-aggregation.html">Global Aggregation</a></span></dt><dt><span class="section"><a href="search-aggregations-bucket-filter-aggregation.html">Filter Aggregation</a></span></dt><dt><span class="section"><a href="search-aggregations-bucket-missing-aggregation.html">Missing Aggregation</a></span></dt><dt><span class="section"><a href="search-aggregations-bucket-nested-aggregation.html">Nested Aggregation</a></span></dt><dt><span class="section"><a href="search-aggregations-bucket-reverse-nested-aggregation.html">Reverse nested Aggregation</a></span></dt><dt><span class="section"><a href="search-aggregations-bucket-terms-aggregation.html">Terms Aggregation</a></span></dt><dt><span class="section"><a href="search-aggregations-bucket-significantterms-aggregation.html">Significant Terms Aggregation</a></span></dt><dt><span class="section"><a href="search-aggregations-bucket-range-aggregation.html">Range Aggregation</a></span></dt><dt><span class="section"><a href="search-aggregations-bucket-daterange-aggregation.html">Date Range Aggregation</a></span></dt><dt><span class="section"><a href="search-aggregations-bucket-iprange-aggregation.html">IPv4 Range Aggregation</a></span></dt><dt><span class="section"><a href="search-aggregations-bucket-histogram-aggregation.html">Histogram Aggregation</a></span></dt><dt><span class="section"><a href="search-aggregations-bucket-datehistogram-aggregation.html">Date Histogram Aggregation</a></span></dt><dt><span class="section"><a href="search-aggregations-bucket-geodistance-aggregation.html">Geo Distance Aggregation</a></span></dt><dt><span class="section"><a href="search-aggregations-bucket-geohashgrid-aggregation.html">GeoHash grid Aggregation</a></span></dt></dl></div><p>A multi-bucket value source based aggregation where buckets are dynamically built - one per unique value.</p><p>Example:</p><pre class="programlisting prettyprint lang-js">{
    "aggs" : {
        "genders" : {
            "terms" : { "field" : "gender" }
        }
    }
}</pre><p>Response:</p><pre class="programlisting prettyprint lang-js">{
    ...

    "aggregations" : {
        "genders" : {
            "buckets" : [
                {
                    "key" : "male",
                    "doc_count" : 10
                },
                {
                    "key" : "female",
                    "doc_count" : 10
                },
            ]
        }
    }
}</pre><p>By default, the <code class="literal">terms</code> aggregation will return the buckets for the top ten terms ordered by the <code class="literal">doc_count</code>. One can
change this default behaviour by setting the <code class="literal">size</code> parameter.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_size_amp_shard_size"></a>Size &amp; Shard Size<a href="https://github.com/elasticsearch/elasticsearch/edit/1.x/docs/reference/search/aggregations/bucket/terms-aggregation.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>The <code class="literal">size</code> parameter can be set to define how many term buckets should be returned out of the overall terms list. By
default, the node coordinating the search process will request each shard to provide its own top <code class="literal">size</code> term buckets
and once all shards respond, it will reduce the results to the final list that will then be returned to the client.
This means that if the number of unique terms is greater than <code class="literal">size</code>, the returned list is slightly off and not accurate
(it could be that the term counts are slightly off and it could even be that a term that should have been in the top
size buckets was not returned). If set to <code class="literal">0</code>, the <code class="literal">size</code> will be set to <code class="literal">Integer.MAX_VALUE</code>.</p><p>The higher the requested <code class="literal">size</code> is, the more accurate the results will be, but also, the more expensive it will be to
compute the final results (both due to bigger priority queues that are managed on a shard level and due to bigger data
transfers between the nodes and the client).</p><p>The <code class="literal">shard_size</code> parameter can be  used to minimize the extra work that comes with bigger requested <code class="literal">size</code>. When defined,
it will determine how many terms the coordinating node will request from each shard. Once all the shards responded, the
coordinating node will then reduce them to a final result which will be based on the <code class="literal">size</code> parameter - this way,
one can increase the accuracy of the returned terms and avoid the overhead of streaming a big list of buckets back to
the client. If set to <code class="literal">0</code>, the <code class="literal">shard_size</code> will be set to <code class="literal">Integer.MAX_VALUE</code>.</p><div class="note admon"><div class="icon"><img alt="Note" src="images/icons/note.png" /></div><div class="admon_content"><p><code class="literal">shard_size</code> cannot be smaller than <code class="literal">size</code> (as it doesn’t make much sense). When it is, elasticsearch will
        override it and reset it to be equal to <code class="literal">size</code>.</p></div></div><p><span class="added">
      [<span class="version">1.1.0</span>]
      <span class="detail">Added in 1.1.0.</span></span> It is possible to not limit the number of terms that are returned by setting <code class="literal">size</code> to <code class="literal">0</code>. Don’t use this
on high-cardinality fields as this will kill both your CPU since terms need to be return sorted, and your network.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_order"></a>Order<a href="https://github.com/elasticsearch/elasticsearch/edit/1.x/docs/reference/search/aggregations/bucket/terms-aggregation.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>The order of the buckets can be customized by setting the <code class="literal">order</code> parameter. By default, the buckets are ordered by
their <code class="literal">doc_count</code> descending. It is also possible to change this behaviour as follows:</p><p>Ordering the buckets by their <code class="literal">doc_count</code> in an ascending manner:</p><pre class="programlisting prettyprint lang-js">{
    "aggs" : {
        "genders" : {
            "terms" : {
                "field" : "gender",
                "order" : { "_count" : "asc" }
            }
        }
    }
}</pre><p>Ordering the buckets alphabetically by their terms in an ascending manner:</p><pre class="programlisting prettyprint lang-js">{
    "aggs" : {
        "genders" : {
            "terms" : {
                "field" : "gender",
                "order" : { "_term" : "asc" }
            }
        }
    }
}</pre><p>Ordering the buckets by single value metrics sub-aggregation (identified by the aggregation name):</p><pre class="programlisting prettyprint lang-js">{
    "aggs" : {
        "genders" : {
            "terms" : {
                "field" : "gender",
                "order" : { "avg_height" : "desc" }
            },
            "aggs" : {
                "avg_height" : { "avg" : { "field" : "height" } }
            }
        }
    }
}</pre><p>Ordering the buckets by multi value metrics sub-aggregation (identified by the aggregation name):</p><pre class="programlisting prettyprint lang-js">{
    "aggs" : {
        "genders" : {
            "terms" : {
                "field" : "gender",
                "order" : { "height_stats.avg" : "desc" }
            },
            "aggs" : {
                "height_stats" : { "stats" : { "field" : "height" } }
            }
        }
    }
}</pre><p>It is also possible to order the buckets based on a "deeper" aggregation in the hierarchy. This is supported as long
as the aggregations path are of a single-bucket type, where the last aggregation in the path may either by a single-bucket
one or a metrics one. If it’s a single-bucket type, the order will be defined by the number of docs in the bucket (i.e. <code class="literal">doc_count</code>),
in case it’s a metrics one, the same rules as above apply (where the path must indicate the metric name to sort by in case of
a multi-value metrics aggregation, and in case of a single-value metrics aggregation the sort will be applied on that value).</p><p>The path must be defined in the following form:</p><pre class="screen">AGG_SEPARATOR       :=  '&gt;'
METRIC_SEPARATOR    :=  '.'
AGG_NAME            :=  &lt;the name of the aggregation&gt;
METRIC              :=  &lt;the name of the metric (in case of multi-value metrics aggregation)&gt;
PATH                :=  &lt;AGG_NAME&gt;[&lt;AGG_SEPARATOR&gt;&lt;AGG_NAME&gt;]*[&lt;METRIC_SEPARATOR&gt;&lt;METRIC&gt;]</pre><pre class="programlisting prettyprint lang-js">{
    "aggs" : {
        "countries" : {
            "terms" : {
                "field" : "address.country",
                "order" : { "females&gt;height_stats.avg" : "desc" }
            },
            "aggs" : {
                "females" : {
                    "filter" : { "term" : { "gender" : { "female" }}},
                    "aggs" : {
                        "height_stats" : { "stats" : { "field" : "height" }}
                    }
                }
            }
        }
    }
}</pre><p>The above will sort the countries buckets based on the average height among the female population.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_minimum_document_count"></a>Minimum document count<a href="https://github.com/elasticsearch/elasticsearch/edit/1.x/docs/reference/search/aggregations/bucket/terms-aggregation.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>It is possible to only return terms that match more than a configured number of hits using the <code class="literal">min_doc_count</code> option:</p><pre class="programlisting prettyprint lang-js">{
    "aggs" : {
        "tags" : {
            "terms" : {
                "field" : "tag",
                "min_doc_count": 10
            }
        }
    }
}</pre><p>The above aggregation would only return tags which have been found in 10 hits or more. Default value is <code class="literal">1</code>.</p><p>Terms are collected and ordered on a shard level and merged with the terms collected from other shards in a second step. However, the shard does not have the information about the global document count available. The decision if a term is added to a candidate list depends only on the order computed on the shard using local shard frequencies. The <code class="literal">min_doc_count</code> criterion is only applied after merging local terms statistics of all shards. In a way the decision to add the term as a candidate is made without being very <span class="emphasis"><em>certain</em></span> about if the term will actually reach the required <code class="literal">min_doc_count</code>. This might cause many (globally) high frequent terms to be missing in the final result if low frequent terms populated the candidate lists. To avoid this, the <code class="literal">shard_size</code> parameter can be increased to allow more candidate terms on the shards. However, this increases memory consumption and network traffic.</p><p><span class="added">
      [<span class="version">1.2.0</span>]
      <span class="detail">Added in 1.2.0.</span></span> <code class="literal">shard_min_doc_count</code> parameter</p><p>The parameter <code class="literal">shard_min_doc_count</code> regulates the <span class="emphasis"><em>certainty</em></span> a shard has if the term should actually be added to the candidate list or not with respect to the <code class="literal">min_doc_count</code>. Terms will only be considered if their local shard frequency within the set is higher than the <code class="literal">shard_min_doc_count</code>. If your dictionary contains many low frequent terms and you are not interested in those (for example misspellings), then you can set the <code class="literal">shard_min_doc_count</code> parameter to filter out candidate terms on a shard level that will with a resonable certainty not reach the required <code class="literal">min_doc_count</code> even after merging the local counts. <code class="literal">shard_min_doc_count</code> is set to <code class="literal">0</code> per default and has no effect unless you explicitly set it.</p><div class="note admon"><div class="icon"><img alt="Note" src="images/icons/note.png" /></div><div class="admon_content"><p>Setting <code class="literal">min_doc_count</code>=<code class="literal">0</code> will also return buckets for terms that didn’t match any hit. However, some of
         the returned terms which have a document count of zero might only belong to deleted documents, so there is
         no warranty that a <code class="literal">match_all</code> query would find a positive document count for those terms.</p></div></div><div class="warning admon"><div class="icon"><img alt="Warning" src="images/icons/warning.png" /></div><div class="admon_content"><p>When NOT sorting on <code class="literal">doc_count</code> descending, high values of <code class="literal">min_doc_count</code> may return a number of buckets
         which is less than <code class="literal">size</code> because not enough data was gathered from the shards. Missing buckets can be
         back by increasing <code class="literal">shard_size</code>.
         Setting <code class="literal">shard_min_doc_count</code> too high will cause terms to be filtered out on a shard level. This value should be set much lower than <code class="literal">min_doc_count/#shards</code>.</p></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_script_11"></a>Script<a href="https://github.com/elasticsearch/elasticsearch/edit/1.x/docs/reference/search/aggregations/bucket/terms-aggregation.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>Generating the terms using a script:</p><pre class="programlisting prettyprint lang-js">{
    "aggs" : {
        "genders" : {
            "terms" : {
                "script" : "doc['gender'].value"
            }
        }
    }
}</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_value_script_7"></a>Value Script<a href="https://github.com/elasticsearch/elasticsearch/edit/1.x/docs/reference/search/aggregations/bucket/terms-aggregation.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><pre class="programlisting prettyprint lang-js">{
    "aggs" : {
        "genders" : {
            "terms" : {
                "field" : "gender",
                "script" : "'Gender: ' +_value"
            }
        }
    }
}</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_filtering_values"></a>Filtering Values<a href="https://github.com/elasticsearch/elasticsearch/edit/1.x/docs/reference/search/aggregations/bucket/terms-aggregation.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>It is possible to filter the values for which buckets will be created. This can be done using the <code class="literal">include</code> and
<code class="literal">exclude</code> parameters which are based on regular expressions.</p><pre class="programlisting prettyprint lang-js">{
    "aggs" : {
        "tags" : {
            "terms" : {
                "field" : "tags",
                "include" : ".*sport.*",
                "exclude" : "water_.*"
            }
        }
    }
}</pre><p>In the above example, buckets will be created for all the tags that has the word <code class="literal">sport</code> in them, except those starting
with <code class="literal">water_</code> (so the tag <code class="literal">water_sports</code> will no be aggregated). The <code class="literal">include</code> regular expression will determine what
values are "allowed" to be aggregated, while the <code class="literal">exclude</code> determines the values that should not be aggregated. When
both are defined, the <code class="literal">exclude</code> has precedence, meaning, the <code class="literal">include</code> is evaluated first and only then the <code class="literal">exclude</code>.</p><p>The regular expression are based on the Java™ <a class="ulink" href="http://docs.oracle.com/javase/7/docs/api/java/util/regex/Pattern.html" target="_top">Pattern</a>,
and as such, they it is also possible to pass in flags that will determine how the compiled regular expression will work:</p><pre class="programlisting prettyprint lang-js">{
    "aggs" : {
        "tags" : {
             "terms" : {
                 "field" : "tags",
                 "include" : {
                     "pattern" : ".*sport.*",
                     "flags" : "CANON_EQ|CASE_INSENSITIVE" <a id="CO22-1"></a><span><img src="images/icons/callouts/1.png" alt="" /></span>
                 },
                 "exclude" : {
                     "pattern" : "water_.*",
                     "flags" : "CANON_EQ|CASE_INSENSITIVE"
                 }
             }
         }
    }
}</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-1"><span><img src="images/icons/callouts/1.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
the flags are concatenated using the <code class="literal">|</code> character as a separator
</p></td></tr></table></div><p>The possible flags that can be used are:
<a class="ulink" href="http://docs.oracle.com/javase/7/docs/api/java/util/regex/Pattern.html#CANON_EQ" target="_top"><code class="literal">CANON_EQ</code></a>,
<a class="ulink" href="http://docs.oracle.com/javase/7/docs/api/java/util/regex/Pattern.html#CASE_INSENSITIVE" target="_top"><code class="literal">CASE_INSENSITIVE</code></a>,
<a class="ulink" href="http://docs.oracle.com/javase/7/docs/api/java/util/regex/Pattern.html#COMMENTS" target="_top"><code class="literal">COMMENTS</code></a>,
<a class="ulink" href="http://docs.oracle.com/javase/7/docs/api/java/util/regex/Pattern.html#DOTALL" target="_top"><code class="literal">DOTALL</code></a>,
<a class="ulink" href="http://docs.oracle.com/javase/7/docs/api/java/util/regex/Pattern.html#LITERAL" target="_top"><code class="literal">LITERAL</code></a>,
<a class="ulink" href="http://docs.oracle.com/javase/7/docs/api/java/util/regex/Pattern.html#MULTILINE" target="_top"><code class="literal">MULTILINE</code></a>,
<a class="ulink" href="http://docs.oracle.com/javase/7/docs/api/java/util/regex/Pattern.html#UNICODE_CASE" target="_top"><code class="literal">UNICODE_CASE</code></a>,
<a class="ulink" href="http://docs.oracle.com/javase/7/docs/api/java/util/regex/Pattern.html#UNICODE_CHARACTER_CLASS" target="_top"><code class="literal">UNICODE_CHARACTER_CLASS</code></a> and
<a class="ulink" href="http://docs.oracle.com/javase/7/docs/api/java/util/regex/Pattern.html#UNIX_LINES" target="_top"><code class="literal">UNIX_LINES</code></a></p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_collect_mode"></a>Collect mode<a href="https://github.com/elasticsearch/elasticsearch/edit/1.x/docs/reference/search/aggregations/bucket/terms-aggregation.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p><span class="coming">
      [<span class="version">coming in 1.3.0</span>]
      <span class="detail">Coming in 1.3.0.</span></span> Deferring calculation of child aggregations</p><p>For fields with many unique terms and a small number of required results it can be more efficient to delay the calculation
of child aggregations until the top parent-level aggs have been pruned. Ordinarily, all branches of the aggregation tree
are expanded in one depth-first pass and only then any pruning occurs. In some rare scenarios this can be very wasteful and can hit memory constraints.
An example problem scenario is querying a movie database for the 10 most popular actors and their 5 most common co-stars:</p><pre class="programlisting prettyprint lang-js">{
    "aggs" : {
        "actors" : {
             "terms" : {
                 "field" : "actors",
                 "size" : 10
             },
            "aggs" : {
                "costars" : {
                     "terms" : {
                         "field" : "actors",
                         "size" : 5
                     }
                 }
            }
         }
    }
}</pre><p>Even though the number of movies may be comparatively small and we want only 50 result buckets there is a combinatorial explosion of buckets
during calculation - a single movie will produce n² buckets where n is the number of actors. The sane option would be to first determine
the 10 most popular actors and only then examine the top co-stars for these 10 actors. This alternative strategy is what we call the <code class="literal">breadth_first</code> collection
mode as opposed to the default <code class="literal">depth_first</code> mode:</p><pre class="programlisting prettyprint lang-js">{
    "aggs" : {
        "actors" : {
             "terms" : {
                 "field" : "actors",
                 "size" : 10,
                 "collect_mode" : "breadth_first"
             },
            "aggs" : {
                "costars" : {
                     "terms" : {
                         "field" : "actors",
                         "size" : 5
                     }
                 }
            }
         }
    }
}</pre><p>When using <code class="literal">breadth_first</code> mode the set of documents that fall into the uppermost buckets are
cached for subsequent replay so there is a memory overhead in doing this which is linear with the number of matching documents.
In most requests the volume of buckets generated is smaller than the number of documents that fall into them so the default <code class="literal">depth_first</code>
collection mode is normally the best bet but occasionally the <code class="literal">breadth_first</code> strategy can be significantly more efficient. Currently
elasticsearch will always use the <code class="literal">depth_first</code> collect_mode unless explicitly instructed to use <code class="literal">breadth_first</code> as in the above example.
Note that the <code class="literal">order</code> parameter can still be used to refer to data from a child aggregation when using the <code class="literal">breadth_first</code> setting - the parent
aggregation understands that this child aggregation will need to be called first before any of the other child aggregations.</p><div class="warning admon"><div class="icon"><img alt="Warning" src="images/icons/warning.png" /></div><div class="admon_content"><p>It is not possible to nest aggregations such as <code class="literal">top_hits</code> which require access to match score information under an aggregation that uses
the <code class="literal">breadth_first</code> collection mode. This is because this would require a RAM buffer to hold the float score value for every document and
this would typically be too costly in terms of RAM.</p></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_execution_hint"></a>Execution hint<a href="https://github.com/elasticsearch/elasticsearch/edit/1.x/docs/reference/search/aggregations/bucket/terms-aggregation.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p><span class="added">
      [<span class="version">1.2.0</span>]
      <span class="detail">Added in 1.2.0.</span></span> The <code class="literal">global_ordinals</code> execution mode</p><p>There are three mechanisms by which terms aggregations can be executed: either by using field values directly in order to aggregate
data per-bucket (<code class="literal">map</code>), by using ordinals of the field values instead of the values themselves (<code class="literal">ordinals</code>) or by using global
ordinals of the field (<code class="literal">global_ordinals</code>). The latter is faster, especially for fields with many unique
values. However it can be slower if only a few documents match, when for example a terms aggregator is nested in another
aggregator, this applies for both <code class="literal">ordinals</code> and <code class="literal">global_ordinals</code> execution modes. Elasticsearch tries to have sensible
defaults when it comes to the execution mode that should be used, but  in case you know that one execution mode may
perform better than the other one, you have the ability to "hint" it to Elasticsearch:</p><pre class="programlisting prettyprint lang-js">{
    "aggs" : {
        "tags" : {
             "terms" : {
                 "field" : "tags",
                 "execution_hint": "map" <a id="CO23-1"></a><span><img src="images/icons/callouts/1.png" alt="" /></span>
             }
         }
    }
}</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO23-1"><span><img src="images/icons/callouts/1.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
the possible values are <code class="literal">map</code>, <code class="literal">ordinals</code> and <code class="literal">global_ordinals</code>
</p></td></tr></table></div><p>Please note that Elasticsearch will ignore this execution hint if it is not applicable.</p></div></div><div class="navfooter"><span class="prev"><a href="search-aggregations-bucket-reverse-nested-aggregation.html">
              « 
              Reverse nested Aggregation</a>
           
        </span><span class="next">
           
          <a href="search-aggregations-bucket-significantterms-aggregation.html">Significant Terms Aggregation
               »
            </a></span></div></article></section></div></div></div><footer><div id="footer_container" class="full_wrapper"><div class="container"><nav role="navigation"><ul id="footer_nav" class="menu"><li id="menu-item-36" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-36"><a target="_blank" href="http://elasticsearch.com">Company</a></li><li id="menu-item-74980" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-74980"><a href="/resources/">Resources</a></li><li id="menu-item-3106" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-3106"><a href="/terms-of-use/">Terms</a></li><li id="menu-item-3107" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-3107"><a href="/privacy-and-cookie-policy/">Privacy</a></li><li id="menu-item-3105" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-3105"><a href="/contact/">Contact</a></li><li id="menu-item-39" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-39"><a href="/blog/">Blog</a></li></ul></nav><div id="social"><a href="https://twitter.com/elasticsearch" class="social_icons" target="_blank"><i class="twitter"></i></a><a href="https://www.facebook.com/elasticsearch" class="social_icons" target="_blank"><i class="facebook"></i></a></div><div id="footer_form"><label class="form_label">Sign up for updates!</label><div class="gf_browser_chrome gform_wrapper" id="gform_wrapper_4"><a id="gf_4" name="gf_4" class="gform_anchor"></a><form method="post" enctype="multipart/form-data" target="gform_ajax_frame_4" id="gform_4" action="/empty-template/#gf_4"><div class="gform_body"><ul id="gform_fields_4" class="gform_fields top_label description_below"><li id="field_4_6" class="gfield               gfield_contains_required"><label class="gfield_label" for="input_4_6">enter you email<span class="gfield_required">*</span></label><div class="ginput_container"><input name="input_6" id="input_4_6" type="email" value="" class="medium" tabindex="50" /></div></li><li id="field_4_2" class="gfield     gform_hidden"><input name="input_2" id="input_4_2" type="hidden" class="gform_hidden" value="813-MAM-392" /></li><li id="field_4_3" class="gfield     gform_hidden"><input name="input_3" id="input_4_3" type="hidden" class="gform_hidden" value="WEB.org" /></li><li id="field_4_4" class="gfield     gform_hidden"><input name="input_4" id="input_4_4" type="hidden" class="gform_hidden" value="WEB.org - Footer - Updates" /></li></ul></div><script type="text/javascript">//<![CDATA[
            jQuery(function(){
                jQuery('#gform_submit_button_4').click( function() {
                    if(window["gf_submitting_4"]){
                        return false;
                    }
                    if( !jQuery("#gform_4")[0].checkValidity || jQuery("#gform_4")[0].checkValidity()){
                        window["gf_submitting_4"]=true;
                    }
                });
            });
            //]]></script><div class="gform_footer top_label"><input type="submit" id="gform_submit_button_4" class="button gform_button" value="Submit" tabindex="51" /><input type="hidden" name="gform_ajax" value="form_id=4&amp;title=&amp;description=" /><input type="hidden" class="gform_hidden" name="is_submit_4" value="1" /><input type="hidden" class="gform_hidden" name="gform_submit" value="4" /><input type="hidden" class="gform_hidden" name="gform_unique_id" value="" /><input type="hidden" class="gform_hidden" name="state_4" value="WyJhOjA6e30iLCJmMjE2MmM2ZjUxYmQ4M2Q3ZmMzNzVlNmY2ODYyZTI2NCJd" /><input type="hidden" class="gform_hidden" name="gform_target_page_number_4" id="gform_target_page_number_4" value="0" /><input type="hidden" class="gform_hidden" name="gform_source_page_number_4" id="gform_source_page_number_4" value="1" /><input type="hidden" name="gform_field_values" value="" /></div></form></div><iframe style="display:none;width:0px; height:0px;" src="about:blank" name="gform_ajax_frame_4" id="gform_ajax_frame_4"></iframe><script type="text/javascript">//<![CDATA[
                    function gformInitSpinner_4(){jQuery('#gform_4').submit(function(){if(jQuery('#gform_ajax_spinner_4').length == 0){jQuery('#gform_submit_button_4, #gform_wrapper_4 .gform_next_button, #gform_wrapper_4 .gform_image_button').after('<' + 'img id="gform_ajax_spinner_4"  class="gform_ajax_spinner" src="http://www.elasticsearch.org/content/plugins/gravityforms/images/spinner.gif" alt="" />'); }} );}jQuery(document).ready(function($){gformInitSpinner_4();jQuery('#gform_ajax_frame_4').load( function(){var contents = jQuery(this).contents().find('*').html();var is_postback = contents.indexOf('GF_AJAX_POSTBACK') >= 0;if(!is_postback){return;}var form_content = jQuery(this).contents().find('#gform_wrapper_4');var is_redirect = contents.indexOf('gformRedirect(){') >= 0;var is_form = !(form_content.length <= 0 || is_redirect);if(is_form){jQuery('#gform_wrapper_4').html(form_content.html());jQuery(document).scrollTop(jQuery('#gform_wrapper_4').offset().top);if(window['gformInitDatepicker']) {gformInitDatepicker();}if(window['gformInitPriceFields']) {gformInitPriceFields();}var current_page = jQuery('#gform_source_page_number_4').val();gformInitSpinner_4();jQuery(document).trigger('gform_page_loaded', [4, current_page]);window['gf_submitting_4'] = false;}else if(!is_redirect){var confirmation_content = jQuery(this).contents().find('#gforms_confirmation_message').html();if(!confirmation_content){confirmation_content = contents;}setTimeout(function(){jQuery('#gform_wrapper_4').replaceWith('<' + 'div id=\'gforms_confirmation_message\' class=\'gform_confirmation_message_4\'' + '>' + confirmation_content + '<' + '/div' + '>');jQuery(document).scrollTop(jQuery('#gforms_confirmation_message').offset().top);jQuery(document).trigger('gform_confirmation_loaded', [4]);window['gf_submitting_4'] = false;}, 50);}else{jQuery('#gform_4').append(contents);if(window['gformRedirect']) {gformRedirect();}}jQuery(document).trigger('gform_post_render', [4, current_page]);} );} );</script><script type='text/javascript'> jQuery(document).ready(function(){jQuery(document).trigger('gform_post_render', [4, 1]) } );
                    //]]></script></div><div class="legal"><p>© 2014 All Rights Reserved - Elasticsearch </p><p>Apache Lucene and Lucene are trademarks of the Apache Software Foundation</p></div></div></div></footer><section id="cookie"><div class="container"><div class="eu">
                Elasticsearch uses cookies to provide a better user experience to visitors of our website. Read more about our cookie policy <a href="/privacy-and-cookie-policy/">here.</a><a data-action="accept" class="cta">Accept cookies</a></div><div class="uk">
                Elasticsearch uses cookies to provide a better user experience to visitors of our website. Read more about our cookie policy <a href="/privacy-and-cookie-policy/">here.</a><a data-action="dismiss" class="cta dismiss">X</a></div></div></section><script type="text/javascript">
      if (window.aiModifyParent) aiModifyParent();
      (function ($, $a, $title, $list) {
        $a = $('[id^="js-api-method-index"]');
        if (!$a.size()) return;
        $('.guide_content').addClass('js-client-docs');
        $list = $a.siblings('.itemizedlist').detach();
        $title = $(document.createElement('h2')).text('api methods')
        $a.parent().remove();
        $('.toc').first().append($(document.createElement('div')).addClass('js-api-method-index').append($title).append($list));
      }(jQuery));
    </script><script type="text/javascript">if(window.aiModifyParent) {aiModifyParent();}</script><script type="text/javascript" src="http://www.elasticsearch.org/content/plugins/prettify-gc-syntax-highlighter/prettify.js?ver=3.5.2"></script><script type="text/javascript" src="http://www.elasticsearch.org/content/plugins/prettify-gc-syntax-highlighter/launch.js?ver=3.5.2"></script><script type="text/javascript" src="http://s0.wp.com/wp-content/js/devicepx-jetpack.js?ver=201413"></script><script type="text/javascript" src="http://www.elasticsearch.org/content/themes/elasticsearch-org/js/global.min.js?ver=1395082598"></script><script type="text/javascript" src="http://www.elasticsearch.org/content/themes/elasticsearch-org/js/froogaloop.min.js?ver=1"></script><script type="text/javascript">
if(jQuery('body').data('cookie') != "eu" || jQuery.cookie('allowCookies')){
    document.write(unescape("%3Cscript src='" + document.location.protocol +
    "//munchkin.marketo.net/munchkin.js' type='text/javascript'%3E%3C/script%3E"));
}
</script><script>
if(jQuery('body').data('cookie') != "eu" || jQuery.cookie('allowCookies')){
    Munchkin.init('813-MAM-392');

    // crazyegg
    setTimeout(function(){var a=document.createElement("script");
    var b=document.getElementsByTagName("script")[0];
    a.src=document.location.protocol+"//dnn506yrbagrg.cloudfront.net/pages/scripts/0014/4686.js?"+Math.floor(new Date().getTime()/3600000);
    a.async=true;a.type="text/javascript";b.parentNode.insertBefore(a,b)}, 1);
}
</script></body></html>
